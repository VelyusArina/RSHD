# RSHD
## Лабораторная работа № 3
### Вариант: 33155

### Задание: 
Цель работы - настроить процедуру периодического резервного копирования базы данных, сконфигурированной в ходе выполнения лабораторной работы №2, а также разработать и отладить сценарии восстановления в случае сбоев.

Узел из предыдущей лабораторной работы используется в качестве основного. Новый узел используется в качестве резервного. Учётные данные для подключения к новому узлу выдаёт преподаватель. В сценариях восстановления необходимо использовать копию данных, полученную на первом этапе данной лабораторной работы.

#### Этап 1. Резервное копирование
- Настроить резервное копирование с основного узла на резервный следующим образом:
  - Первоначальная полная копия + непрерывное архивирование. Включить для СУБД режим архивирования WAL; настроить копирование WAL (scp) на резервный узел; создать первоначальную резервную копию (pg_basebackup), скопировать на резервный узел (rsync).
- Подсчитать, каков будет объем резервных копий спустя месяц работы системы, исходя из следующих условий:
  - Средний объем новых данных в БД за сутки: 400МБ.
  - Средний объем измененных данных за сутки: 500МБ.
- Проанализировать результаты.
#### Этап 2. Потеря основного узла

Этот сценарий подразумевает полную недоступность основного узла. Необходимо восстановить работу СУБД на РЕЗЕРВНОМ узле, продемонстрировать успешный запуск СУБД и доступность данных.

#### Этап 3. Повреждение файлов БД
Этот сценарий подразумевает потерю данных (например, в результате сбоя диска или файловой системы) при сохранении доступности основного узла. Необходимо выполнить полное восстановление данных из резервной копии и перезапустить СУБД на ОСНОВНОМ узле.

Ход работы:

- Симулировать сбой:
  - удалить с диска директорию конфигурационных файлов СУБД со всем содержимым.
- Проверить работу СУБД, доступность данных, перезапустить СУБД, проанализировать результаты.
- Выполнить восстановление данных из резервной копии, учитывая следующее условие:
  - исходное расположение директории PGDATA недоступно - разместить данные в другой директории и скорректировать конфигурацию.
- Запустить СУБД, проверить работу и доступность данных, проанализировать результаты.

#### Этап 4. Логическое повреждение данных
Этот сценарий подразумевает частичную потерю данных (в результате нежелательной или ошибочной операции) при сохранении доступности основного узла. Необходимо выполнить восстановление данных на ОСНОВНОМ узле следующим способом:

- Генерация файла на резервном узле с помощью pg_dump и последующее применение файла на основном узле.

Ход работы:

- В каждую таблицу базы добавить 2-3 новые строки, зафиксировать результат.
- Зафиксировать время и симулировать ошибку:
  - удалить каждую вторую строку в любой таблице (DELETE)
- Продемонстрировать результат.
- Выполнить восстановление данных указанным способом.
- Продемонстрировать и проанализировать результат.

#### Вопросы для подготовки к защите
- Резервные копии: назначение; локальные и удаленные; полные и инкрементные; холодные и горячие.
- Сравнение подходов SQL Dump, FS Level Backup, Continuous Archiving: применимость, преимущества, недостатки.
- Как рассчитать объем пространства для хранения резервных копий, от чего зависит?
- Как рассчитать требуемую производительность канала для выполнения резервных копий по сети, от чего зависит?
- Какие факторы оказывают влияние на скорость восстановления, почему?

#### Выполнение:
#### Этап 1. Резервное копирование
На остновном узле включаем режим архивирования WAL и настраиваем копирование(scp) на резервный узел.

gkt53/postgres_conf :
'''
wal_level = replica
archive_mode = on
archive_command = 'scp %p postgres1@pg193:~/lab3/pg_wal/%f'
'''


  

